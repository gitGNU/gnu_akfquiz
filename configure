#! /bin/sh

#####################################################################
# configure here:

PREFIX=/usr/local
CGIPATH=/usr/lib/cgi-bin

# for modified versions use a variant-name please
#VARIANT=""
VARIANT="-testing"
NAME="AKFQuiz"

MAINVERSION=4
SUBVERSION=3
REVISION=2

VERSION=$MAINVERSION.$SUBVERSION.$REVISION
SVERSION=$MAINVERSION$SUBVERSION$REVISION

#####################################################################
# functions

help() {
cat <<AMEN
./configure [options]

options:
  -h | --help
  --prefix=
  --cgipath=
  --variant=
  --arch=
  --sys=
  --with-gpc
  --with-fpc
  --with-xw32
  --with-xarm
AMEN
exit
}

getcompiler() {
  # search for available compiler
  if which fpc
  then COMPILER=fpc
  elif which gpc
  then COMPILER=gpc
  else echo 1>&2 "error: neither gpc nor fpc found"; exit 1
  fi
  }

convert_rc() {
  mv "$1" "$1.old"
  sed < "$1.old" > "$1" \
    -e "s/^\(FILEVERSION\).*/\1 $MAINVERSION, $SUBVERSION, $REVISION, 0/" \
    -e "s/^\(PRODUCTVERSION\).*/\1 $MAINVERSION, $SUBVERSION, $REVISION, 0/" \
    -e "s/\(.*VALUE \"FileVersion\", *\)\".*\"/\1\"$VERSION$VARIANT\"/" \
    -e "s/\(.*VALUE \"ProductName\", *\)\".*\"/\1\"$NAME\"/" \
    -e "s/\(.*VALUE \"ProductVersion\", *\)\".*\"/\1\"$VERSION$VARIANT\"/"
    }

notsupported() {
  echo 1>&2 "not supported: $1"
  }

#####################################################################
# main program:

SYS=`uname -s`
ARCH=`uname -m`
# rename architecture
case "$ARCH" in
   i?86) ARCH=x86 ;;
esac

# check parameter
while [ $# -gt 0 ] 
do
  case "$1" in
    -h | --help)   help ;;
    --target=gpc | --target=fpc | --target=xw32 | --target=xarm)
                   echo 1>&2 "old usage for --target no longer supported!"
		   exit 1 ;;
    --srcdir=*)    notsupported --srcdir ;; # yet to be implemented
    --build=*)     notsupported --build ;; # yet to be implemented
    --host=*)      notsupported --host ;;  # yet to be implemented
    --target=*)    notsupported --target ;; # yet to be implemented
    --with-gpc)    COMPILER=gpc ;;
    --with-fpc)    COMPILER=fpc ;;
    --with-xw32)   COMPILER=xw32 ;;
    --with-xarm)   COMPILER=xarm ;;
    --with-*)      ;; # ignore (see GNU Coding Standards)
    --gpc)         COMPILER=gpc ;;
    --fpc)         COMPILER=fpc ;;
    --xw32)        COMPILER=xw32 ;;
    --xarm)        COMPILER=xarm ;;
    --enable-*)    ;; # ignore (see GNU Coding Standards)
    --prefix=*)    PREFIX=`echo "$1" | sed -e "s/--prefix=\(.*\)/\1/"` ;;
    --cgipath=*)   CGIPATH=`echo "$1" | sed -e "s/--cgipath=\(.*\)/\1/"` ;;
    --variant=*)   VARIANT=-`echo "$1" | sed -e "s/--variant=\(.*\)/\1/"` ;;
    --arch=*)      ARCH=`echo "$1" | sed -e "s/--arch=\(.*\)/\1/"` ;;
    --sys=*)       SYS=`echo "$1" | sed -e "s/--sys=\(.*\)/\1/"` ;;
    -*) echo 1>&2 "error: unknown parameter $1"; exit 1 ;;
    *) ;; # ignore for now
  esac
  shift
done

test -z "$COMPILER" && getcompiler

test "$COMPILER" = "xarm" && ARCH=arm
test "$COMPILER" = "xw32" && SYS=w32

VERSION=$MAINVERSION.$SUBVERSION.$REVISION
SVERSION=$MAINVERSION$SUBVERSION$REVISION

# show settings:
cat << AMEN
PREFIX:   $PREFIX
CGIPATH:  $CGIPATH
NAME:     $NAME
VARIANT:  $VARIANT
VERSION:  $VERSION
SVERSION: $SVERSION
COMPILER: $COMPILER
SYS:      $SYS
ARCH:     $ARCH
AMEN

# change to default directory
cd $(dirname $0)

sed < Makefile.in > Makefile \
    -e "s/ARCH=.*/ARCH=$ARCH/" \
    -e "s/SYS=.*/SYS=$SYS/" \
    -e "s/^\(VERSION *= *\).*/\1$VERSION/" \
    -e "s/^\(SVERSION *= *\).*/\1$SVERSION/"

cp srcbin/Makefile.$COMPILER srcbin/Makefile

sed < srcbin/common.in > srcbin/common.mak \
    -e "s%^\(prefix *= *\).*%\1$PREFIX%" \
    -e "s%^\(cgidir *= *\).*%\1$CGIPATH%"

cat > srcbin/config.inc <<AMEN
{ this file was generated automatically using configure
  do not edit this by hand }

const AKFQuizName = '$NAME$VARIANT';
const AKFQuizVersion = '$VERSION';
AMEN

if [ -w ../autopackage/default.apspec ]
then
  mv ../autopackage/default.apspec ../autopackage/default.apspec.old
  sed < ../autopackage/default.apspec.old > ../autopackage/default.apspec \
      -e "s/^\(SoftwareVersion: *\).*/\1$VERSION/"
fi

# Windows stuff

mv srcbin/w32/akfquiz.iss srcbin/w32/akfquiz.iss.old
sed < srcbin/w32/akfquiz.iss.old > srcbin/w32/akfquiz.iss \
    -e "s/^\(AppName=\).*/\1$NAME$VARIANT/" \
    -e "s/^\(AppVerName=\).*/\1$NAME$VARIANT $VERSION/" \
    -e "s/^\(OutputBaseFileName=\).*/\1akfquiz$VARIANT-${VERSION}-w32/" \
    -e "s/^\(VersionInfoVersion=\).*/\1$VERSION/"

convert_rc srcbin/w32/scrquiz.rc
convert_rc srcbin/w32/mkquiz.rc
convert_rc srcbin/w32/cgiquiz.rc
convert_rc srcbin/w32/linequiz.rc
convert_rc srcbin/w32/grquiz.rc
convert_rc srcbin/w32/wquizchooser.rc
